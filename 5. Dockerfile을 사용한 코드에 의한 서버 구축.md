# 5. Dockerfile을 사용한 코드에 의한 서버 구축

## 5.1 Dokerfile을 사용한 구성 관리
#### 1. Dockerfile이란?
* Docker image -생성-> Docker container -수행-> OS설정, 미들웨어 설치, 파리미터의 설정 등 => 수동 수행
* 'container server'를 바탕으로 -생성-> Docker image  

* Dockerfile
	- Docker 상에서 작동시킬 컨테이너의 구성 정보를 기술하기 위한 파일
	- 쥬요 구성 정보
		+ 베이스가 될 Docker __이미지__
		+ Docker 컨테이너 안세서 수행한 조작__(명령)__
		+ 환경__변수__ 등의 설정
		+ Docker 컨테이너 안에서 작동시키켜둘 __데몬__ 실행

---
#### 2. Dockerfile의 기본 구문
* 'Dockerfile'에 인프라 구성 정보를 기술
* 다른 이름을 사용해도 되지만, 이미지를 빌드할 때 파일명을 명시적으로 지정 필요  

* 기본 서식
`명령 인수`  

* Dockerfile의 명령
명령|설명
---|---
FROM| 베이스 이미지를 지정, Ex) FROM ubuntu:14.04(latest도 가능하지만, 명시적 지정 권장)
RUN| 이미지상에서 명령 실행, Ex) RUN apt-get update && apt-get install -y fortune
CMD| 컨테이너 실행 명령, Ex) CMD ["nginx"] -> nginx 서버 구동
LABEL| 라벨 설정
EXPOSE| 컨테이너 공개 포트 설정
ENV| 환경변수, Ex) 'ENV NGINX_VERSION 버전명'
ADD| 파일/디렉터리 추가
COPY| 이미지상의 파일 복사, Ex) 'COPY jerkins.sh /user/local/bin/jenkins.sh' (압축풀기가 필요한 경우 ADD 사용)
WORKDIR| 작업 디렉터리
ARG| Dockerfile 안의 변수
ONBULID| 빌드 완료 후 실행되는 명령
ENTRYPOINT| 컨테이너 실행 명령(이미지 실행 명령을 다시 지정하기 위해 사용)
VOLUME| 볼륨 마운트, 컨테이너 자체는 stateless한 특성을 가짐
USER| 사용자 지정, (기본값 'docker')
STOPSIGNAL| 시스템 콜 시그널 설정
HEALTHCHECK| 컨테이너의 헬스 체크
SHELL| 기본 쉘 지정
* '#'을 사용해 주석 처리

---
#### 3. Dockerfile 작성
`FROM [이미지명]`  
`FROM [이미지명]:[태그명]`  
`FROM [이미지명]@[다이제스트]`  
* 태그명 생략시 최신 버전(latest)이 적용됨
* Digest를 사용하면 이미지를 고유하게 지정 가능

Ex) ContOS를 베이스 이미지한 Dockerfile
```docker
# 베이스 이미지 설정
FROM centos:centos7
```

Ex) Digest를 사용한 Dockerfile
```bash
root@Ubuntu:~# docker image ls --digests
REPOSITORY          TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE
nginx               latest              sha256:380eb808e2a3b0dd954f92c1cae2f845e6558a15037efefcabc5b4e03d666d03   a1523e859360        7 days ago          127MB
```
```docker
# 베이스 이미지 설정
FROM nginx@sha256:380eb808e2a3b0dd954f92c1cae2f845e6558a15037efefcabc5b4e03d666d03
```

---
## 5.2 Dockerfile의 빌드와 이미지 레이어

---
#### 1. Dockerfile로부터 Docker 이미지 만들기
`docker build -t [생성할 이미지명]:[태그명] [Dockerfile의 위치]`  


Ex) Dockerfile 작성  
```bash
root@Ubuntu:~# mkdir sample && cd $_
root@Ubuntu:sample# touch Dockerfile
root@Ubuntu:sample# ls
Dockerfile
```

Ex) Dockerfile 내용   
```docker
# 베이스 이미지 설정
FROM centos:centos7
```

Ex) docker build 명령의 실행
```bash
root@Ubuntu:sample# docker build -t sample:1.0 /root/sample
Sending build context to Docker daemon  2.048kB
Step 1/1 : FROM cetos:contos7
pull access denied for cetos, repository does not exist or may require 'docker login': denied: requested access to the resource is denied
root@Ubuntu:sample# vim Dockerfile 
root@Ubuntu:sample# docker logout
Removing login credentials for https://index.docker.io/v1/
root@Ubuntu:sample# docker build -t sample:1.0 /root/sample
Sending build context to Docker daemon  2.048kB
Step 1/1 : FROM centos:centos7
centos7: Pulling from library/centos
ab5ef0e58194: Pull complete 
Digest: sha256:4a701376d03f6b39b8c2a8f4a8e499441b0d567f9ab9d58e4991de4472fb813c
Status: Downloaded newer image for centos:centos7
 ---> 5e35e350aded
Successfully built 5e35e350aded
```
* 절대경로, 상대경로 모두 가능
* 처음은 로컬 환경에서 베이스 이미지를 찾고 없으면 Docker repository에서 다운로드 함


Ex) 이미지 확인  
```bash
root@Ubuntu:sample# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              a1523e859360        7 days ago          127MB
sample              1.0                 5e35e350aded        3 months ago        203MB
```

Ex) 새로운 이미지 작성  
```bash
root@Ubuntu:sample# docker build -t sample:2.0 /root/sample
Sending build context to Docker daemon  2.048kB
Step 1/1 : FROM centos:centos7
 ---> 5e35e350aded
Successfully built 5e35e350aded
Successfully tagged sample:2.0
```
* 다운로드 하지 않고 바로 이미지 작성

Ex) 새로운 이미지 확인  
```bash
root@Ubuntu:sample# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              a1523e859360        7 days ago          127MB
centos              centos7             5e35e350aded        3 months ago        203MB
sample              1.0                 5e35e350aded        3 months ago        203MB
sample              2.0                 5e35e350aded        3 months ago        203MB
```
* 베이스 이미지(centos)의  'IMAGE ID'가 같으며, 모두 동일한 이미지를 뜻함

Ex) 파일명을 지정해 Docker 빌드  
```bash
root@Ubuntu:sample# docker build -t sample -f Dockerfile.base .
Sending build context to Docker daemon  3.072kB
Step 1/1 : FROM centos:centos7
 ---> 5e35e350aded
Successfully built 5e35e350aded
Successfully tagged sample:latest
root@Ubuntu:sample# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              a1523e859360        7 days ago          127MB
centos              centos7             5e35e350aded        3 months ago        203MB
sample              1.0                 5e35e350aded        3 months ago        203MB
sample              2.0                 5e35e350aded        3 months ago        203MB
sample              latest              5e35e350aded        3 months ago        203MB
```
* '.' : 현재 디렉토리를 나타내니 빠트리지 말 것

Ex) 표준입력 방식 빌드  
```bash
root@Ubuntu:sample# docker build - < Dockerfile
Sending build context to Docker daemon  2.048kB
Step 1/1 : FROM centos:centos7
 ---> 5e35e350aded
Successfully built 5e35e350aded
```
* '-' : 표준 입력으로 내용을 받음
* 이 방법으로는 다른 필요 파일을 포함 시킬 수 없음

Ex) 압축 아카이브 이용 빌드  
```dockerfile
# base image config
FROM centos:centos7
ADD dummyfile /tmp/dummyfile
```
```bash
root@Ubuntu:sample# tar tfvz docker.tar.gz
-rw-r--r-- root/root        40 2020-03-05 16:26 Dockerfile
-rw-r--r-- root/root        29 2020-03-05 16:53 dummyfile
root@Ubuntu:sample# docker build - < docker.tar.gz
Sending build context to Docker daemon     204B
Step 1/2 : FROM centos:centos7
 ---> 5e35e350aded
Step 2/2 : ADD dummyfile /tmp/dummyfile
 ---> c5867e533600
Successfully built c5867e533600
```

---
#### 2. Docker 이미지 레이어 구조
* Docerfile은 명령별로 이미지 작성
* 여러개의 이미지는 레이어 구조도 되어 있음
![레이어 구조](./5. Dockerfile을 사용한 코드에 의한 서버 구축/docker_00_layers1.png)[^레이어구조]
* 쉽게 설명하면, 계층적 구조처럼 이미지들이 'Stap:1`부터 쌓인다고 할 수 있음(이미지가 겹침)
* 상위 계층의 이미지는 `IMAGE ID`를 공유하여 사용해, 불필요한 용량을 줄임  


Ex) 4개의 명령을 갖는 Dockerfile  
```dockerfile
# base image config
# STEP:1 Ubuntu
FROM ubuntu:latest

# STEP:2 Nginx Install
RUN apt-get update && apt-get install -y -q nginx

# STEP:3 File Copy
COPY index.html /usr/share/nginx/html/

# Step:4 Ngins Start
CMD ["nginx", "-g", "daemmon off;"]
```
* 임의의 'index.html' 파일을 생성

Ex) 이미지 레이어 구조  
```bash
root@Ubuntu:sample# docker build -t wabapp .
Sending build context to Docker daemon  4.608kB
Step 1/4 : FROM ubuntu:latest
latest: Pulling from library/ubuntu
423ae2b273f4: Pull complete 
de83a2304fa1: Pull complete 
f9a83bce3af0: Pull complete 
b6b53be908de: Pull complete 
Digest: sha256:04d48df82c938587820d7b6006f5071dbbffceb7ca01d2814f81857c631d44df
Status: Downloaded newer image for ubuntu:latest
 ---> 72300a873c2c											# 첫번째 이미지 작성
Step 2/4 : RUN apt-get update && apt-get install -y -q nginx
 ---> Running in 2819fafa29b0
Get:1 http://archive.ubuntu.com/ubuntu bionic InRelease [242 kB]
~생략~
Removing intermediate container 2819fafa29b0
 ---> 2c7d1acb4d21											# 두번째 이미지 작성
Step 3/4 : COPY index.html /usr/share/nginx/html/
 ---> c6b394219c70											# 세번째 이미지 작성
Step 4/4 : CMD ["nginx", "-g", "daemmon off;"]
 ---> Running in c04f9ce3b639
Removing intermediate container c04f9ce3b639
 ---> c47fdf6dc79a											# 네번째 이미지 작성
Successfully built c47fdf6dc79a
Successfully tagged wabapp:late
```
* 이미지는 계층적으로 'Strp:1'부터 차례대로 쌓임
* 이래층에 있는 이미지는 상위 계층과 공유가 되어, 디스크 용량을 효율적으로 사용

##### Docker Hub도 이미지 관리
* Docker Hub도 이미지를 레이어로 겹여서 작성하여, 공통된 이미지를 공유 관리

---
## 5.3 멀티스테이지 빌드를 사용한 애플리케이션 개발

---
#### 1. 
`docker network ls [옵션]`  
	* 주요 옵션  

Ex)   
```bash

```

---
#### 2. 

---
## 5.4 명령 및 데몬 실행

---
#### 1. 

---
## 5.5 환경 및 네트워크 설정

---
#### 1. 
`docker container commit [옵션] 컨테이너_식별자 [이미지명[:태그명]]`  
	* 주요 옵션  
	
	
Ex) 
```bash

```

---
#### 2. 


Ex) 
```bash

```

---
## 5.6 파일 설정

---
[^레이어구조]:https://adeeshfulay.wordpress.com/2017/09/08/understanding-docker-images-and-layers/